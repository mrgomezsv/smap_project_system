{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Administración de Chat</h2>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="chatTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="active-chats-tab" data-bs-toggle="tab" href="#active-chats" role="tab" aria-controls="active-chats" aria-selected="true">
                Chats Activos
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="add-admin-tab" data-bs-toggle="tab" href="#add-admin" role="tab" aria-controls="add-admin" aria-selected="false">
                Agregar Administrador
            </a>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content mt-3" id="chatTabsContent">
        <!-- Pestaña de Chats Activos -->
        <div class="tab-pane fade show active" id="active-chats" role="tabpanel" aria-labelledby="active-chats-tab">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <div>
                    <h3>Chats Activos</h3>
                    <p>En esta pestaña, podrás ver y responder a los chats activos con los usuarios.</p>
                </div>
                <!-- Formulario de Búsqueda -->
                <form class="d-flex ms-3 my-2" role="search" method="get">
                    <div class="input-group">
                        <span class="input-group-text" id="search-icon">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar..." aria-label="Buscar" aria-describedby="search-icon">
                    </div>
                </form>
            </div>

            <div class="row">
                <!-- Lista de chats -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="chatList">
                                {% for chat in active_chats %}
                                <a href="#" class="list-group-item list-group-item-action chat-item" data-chat-id="{{ chat.id }}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ chat.user.username }}</h6>
                                        <small>{{ chat.last_message_at|timesince }}</small>
                                    </div>
                                    <p class="mb-1 text-muted">{{ chat.last_message|truncatechars:50 }}</p>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Área de chat -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0" id="currentChatUser">Seleccione un chat</h5>
                        </div>
                        <div class="card-body">
                            <div class="chat-messages" id="chatMessages" style="height: 400px; overflow-y: auto;">
                                <!-- Los mensajes se cargarán aquí dinámicamente -->
                            </div>
                            <form id="messageForm" class="mt-3" style="display: none;">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="text" class="form-control" id="messageInput" placeholder="Escriba su mensaje...">
                                    <button class="btn btn-primary" type="submit">Enviar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de Agregar Administrador -->
        <div class="tab-pane fade" id="add-admin" role="tabpanel" aria-labelledby="add-admin-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Agregar Administrador de Chat</h3>
                    <p>En este apartado puede agregar nuevos administradores que tendrán acceso al sistema de chat.</p>
                    <form method="post" action="{% url 'add_chat_admin' %}" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Administrador</button>
                    </form>

                    <hr>

                    <h3>Lista de Administradores</h3>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Estado</th>
                                    <th>Fecha de Creación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for admin in chat_admins %}
                                <tr>
                                    <td>{{ admin.email }}</td>
                                    <td>
                                        <span class="badge {% if admin.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ admin.is_active|yesno:"Activo,Inactivo" }}
                                        </span>
                                    </td>
                                    <td>{{ admin.created_at }}</td>
                                    <td>
                                        <form method="post" action="{% url 'toggle_chat_admin' admin.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm {% if admin.is_active %}btn-danger{% else %}btn-success{% endif %}">
                                                {{ admin.is_active|yesno:"Desactivar,Activar" }}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Script para el manejo del chat -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatList = document.getElementById('chatList');
    const chatMessages = document.getElementById('chatMessages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    let currentChatId = null;

    // Función para cargar mensajes
    function loadMessages(chatId) {
        fetch(`/chat/messages/${chatId}/`)
            .then(response => response.json())
            .then(data => {
                chatMessages.innerHTML = '';
                data.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.is_admin ? 'admin' : 'user'}`;
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <strong>${message.sender}</strong>
                            <p>${message.content}</p>
                            <small>${message.timestamp}</small>
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }

    // Evento para seleccionar un chat
    chatList.addEventListener('click', function(e) {
        const chatItem = e.target.closest('.chat-item');
        if (chatItem) {
            e.preventDefault();
            currentChatId = chatItem.dataset.chatId;
            
            // Actualizar UI
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            chatItem.classList.add('active');
            document.getElementById('currentChatUser').textContent = chatItem.querySelector('h6').textContent;
            messageForm.style.display = 'block';
            
            loadMessages(currentChatId);
        }
    });

    // Evento para enviar mensaje
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentChatId) return;

        const message = messageInput.value.trim();
        if (!message) return;

        fetch(`/chat/send/${currentChatId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                loadMessages(currentChatId);
            }
        });
    });

    // Actualizar mensajes cada 5 segundos
    setInterval(() => {
        if (currentChatId) {
            loadMessages(currentChatId);
        }
    }, 5000);

    // Script de Búsqueda
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');

            chatItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
});
</script>

<style>
.chat-messages {
    padding: 1rem;
}

.message {
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
}

.message.admin {
    background-color: #e3f2fd;
    margin-left: 20%;
}

.message.user {
    background-color: #f5f5f5;
    margin-right: 20%;
}

.message-content {
    padding: 0.5rem;
}

.message-content strong {
    display: block;
    margin-bottom: 0.25rem;
}

.message-content small {
    color: #666;
    font-size: 0.8rem;
}

.chat-item.active {
    background-color: #e3f2fd;
    border-color: #90caf9;
}
</style>
{% endblock %} 