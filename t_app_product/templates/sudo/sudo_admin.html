{% extends 'base.html' %}

{% block content %}
    <head>
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/sudo_admin.css' %}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    </head>

<nav class="navbar navbar-expand-lg navbar-light bg-light" style="background-color: #F4F1FF !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
    <div class="container d-flex align-items-center">
        <h2 class="h2">Usuarios Registrados</h2>
        <div class="d-flex ml-auto">
            <div class="dropdown mx-2">
              <a class="btn btn-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Acciones
              </a>
              <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'product' %}">Gestión de Productos</a></li>
                  <li><a class="dropdown-item" href="{% url 'waiver' %}">Gestión de Waivers</a></li>
                  <li><a class="dropdown-item" href="{% url 'firebase_auth' %}">Usuarios de Firebase</a></li>
                  <li><a class="dropdown-item" href="{% url 'event' %}">Gestión de Eventos</a></li>
                  <li><a class="dropdown-item" href="{% url 'chats' %}">Chats</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><h6 class="dropdown-header">APIs del Sistema</h6></li>
                  <li><a class="dropdown-item" href="/api/products/" target="_blank">Productos API</a></li>
                  <li><a class="dropdown-item" href="/api/products/category/JUGUETES/" target="_blank">Productos por Categoría API</a></li>
                  <li><a class="dropdown-item" href="/api/v2/waiver/" target="_blank">Waiver API v2</a></li>
                  <li><a class="dropdown-item" href="/api/v2/waiver/validate-waiver-status/" target="_blank">Validar Waiver API</a></li>
                  <li><a class="dropdown-item" href="/api/v2/waiver/user/test/" target="_blank">Usuarios Waiver API</a></li>
                  <li><a class="dropdown-item" href="/api/v2/waiver/QR123/" target="_blank">QR Waiver API</a></li>
              </ul>
            </div>
            <a id="createUserButtom" href="{% url 'signup' %}" class="btn btn-primary ml-2">Nuevo Usuario</a>
        </div>
    </div>
</nav>

<body style="background-color: #F4F1FF">
    <div class="container mt-5" style="background-color: #F4F1FF !important">
        {% csrf_token %}
        {% if error_message %}
            <!-- Mensaje de error -->
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-exclamation-circle"></i>
                    Error al cargar usuarios
                </h4>
                <p>{{ error_message }}</p>
            </div>
        {% elif users %}
            <table class="table" style="background-color: #F4F1FF !important">
                <thead>
                <tr style="background-color: #F4F1FF !important">
                    <th><input type="checkbox" id="select-all"></th> <!-- Checkbox para seleccionar todos -->
                    <th>ID</th>
                    <th>Nombre de Usuario</th>
                    <th>Correo Electrónico</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Fecha de Registro</th>
                    <th>Ultimo Inicio de Sesion</th>
                    <th class="trash-column"></th> <!-- Columna para el icono del bote de basura -->
                </tr>
                </thead>
                <tbody style="background-color: #F4F1FF !important">
                {% for user in users %}
                    <tr>
                        <td class="checkbox-container">
                            <input type="checkbox" name="selected_users" value="{{ user.id }}"
                                   id="user-checkbox-{{ user.id }}"
                                   onchange="toggleTrashIconVisibility('{{ user.id }}')">
                            <label for="user-checkbox-{{ user.id }}" class="checkbox-label"></label>
                        </td> <!-- Checkbox de usuario -->
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email|default:"N/A" }}</td>
                        <td>{{ user.first_name|default:"N/A" }}</td>
                        <td>{{ user.last_name|default:"N/A" }}</td>
                        <td>{{ user.date_joined|date:"d/m/Y H:i" }}</td>
                        <td>{{ user.last_login|date:"d/m/Y H:i"|default:"Nunca" }}</td>
                        <td class="form-check me-3 hide-trash trash-column"
                            id="trash-icon-{{ user.id }}">
                            <button type="button" 
                                    class="btn btn-link text-danger p-0" 
                                    onclick="confirmDeleteUser('{{ user.id }}', '{{ user.username }}')"
                                    title="Eliminar usuario">
                                <i class="fas fa-trash-alt trash-icon mr-2"></i>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-info-circle"></i>
                    No hay usuarios registrados
                </h4>
                <p>No se encontraron usuarios en el sistema.</p>
            </div>
        {% endif %}
    </div>
</body>

    <script>
        function toggleTrashIconVisibility(userId) {
            var checkbox = document.getElementById('user-checkbox-' + userId);
            var trashIcon = document.getElementById('trash-icon-' + userId);
            if (checkbox.checked) {
                trashIcon.classList.remove('hide-trash');
            } else {
                trashIcon.classList.add('hide-trash');
            }
        }

        // Función para seleccionar/deseleccionar todos
        document.getElementById('select-all').addEventListener('change', function() {
            var checkboxes = document.querySelectorAll('input[name="selected_users"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = this.checked;
                toggleTrashIconVisibility(checkbox.value);
            });
        });

        // Función para confirmar eliminación de usuario
        function confirmDeleteUser(userId, username) {
            if (confirm(`¿Estás seguro de que quieres eliminar al usuario "${username}"?\n\nEsta acción no se puede deshacer.`)) {
                deleteUser(userId);
            }
        }

        // Función para eliminar usuario
        function deleteUser(userId) {
            // Crear un formulario temporal para enviar la solicitud POST
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = `/sudo_admin/delete/${userId}/`;
            
            // Agregar el token CSRF
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = getCookie('csrftoken');
            }
            form.appendChild(csrfToken);
            
            // Agregar el formulario al documento y enviarlo
            document.body.appendChild(form);
            form.submit();
        }

        // Función para obtener el token CSRF de las cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}
