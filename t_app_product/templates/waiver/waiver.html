{% extends 'base.html' %}

{% block content %}
{% with request.GET.active_tab|default:'registered-users' as active_tab %}
<div class="container mt-5">
    <h2>Administración de Datos de Waiver</h2>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="waiverTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if active_tab == 'registered-users' %}active{% endif %}" id="registered-users-tab" data-bs-toggle="tab" href="#registered-users" role="tab" aria-controls="registered-users" aria-selected="{% if active_tab == 'registered-users' %}true{% else %}false{% endif %}">
                Clientes Registrados en el Waiver
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if active_tab == 'add-email' %}active{% endif %}" id="add-email-tab" data-bs-toggle="tab" href="#add-email" role="tab" aria-controls="add-email" aria-selected="{% if active_tab == 'add-email' %}true{% else %}false{% endif %}">
                Agregar Colaborador
            </a>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content mt-3" id="waiverTabsContent">
        <!-- Pestaña de Clientes Registrados en el Waiver -->
        <div class="tab-pane fade {% if active_tab == 'registered-users' %}show active{% endif %}" id="registered-users" role="tabpanel" aria-labelledby="registered-users-tab">
            <!-- Contenido existente de esta pestaña -->
            <!-- ... (tu código existente) ... -->
        </div>

        <!-- Pestaña de Agregar Correo Electrónico -->
        <div class="tab-pane fade {% if active_tab == 'add-email' %}show active{% endif %}" id="add-email" role="tabpanel" aria-labelledby="add-email-tab">
            <!-- Contenido existente de esta pestaña -->
            <!-- Formulario para agregar colaborador -->
            <h3>Agregar Colaborador</h3>
            <p>En este apartado agregaremos los correos electrónicos de los colaboradores que validarán (escanearán) el QR de cada cliente en la APP.</p>
            <form method="post" novalidate>
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Agregar</button>
            </form>

            <hr>

            <!-- Tabla de correos electrónicos -->
            <h3>Lista de Correos Electrónicos Autorizados para Validar QR en la APP</h3>
            <p>Este es el listado de personas que tendrán acceso a Custom Waiver Validator en la APP. Ahora puedes eliminar colaboradores seleccionando el checkbox y haciendo clic en el ícono de basurero.</p>
            <form method="post" id="delete-form">
                {% csrf_token %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Email</th>
                            <th>Fecha de Creación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for validator in waiver_validators %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="item-checkbox">
                                </td>
                                <td>{{ validator.email }}</td>
                                <td>{{ validator.created_at }}</td>
                                <td>
                                    <button type="submit" formaction="{% url 'delete_validator' validator_id=validator.id %}" formmethod="post" class="btn btn-link trash-icon" style="display: none;" onclick="return confirm('¿Estás seguro de que deseas eliminar este colaborador?');">
                                        {% csrf_token %}
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>
</div>
{% endwith %}

<!-- Incluir Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Script de Búsqueda y manejo de checkbox -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Script de Búsqueda
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            const table = document.getElementById('clientesTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            searchInput.addEventListener('keyup', function() {
                const filter = searchInput.value.toLowerCase();

                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let match = false;

                    for (let j = 0; j < cells.length; j++) {
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.indexOf(filter) > -1) {
                            match = true;
                            break;
                        }
                    }

                    if (match) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }

                // Mostrar mensaje si no hay coincidencias
                const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
                const noResultsMessage = document.getElementById('no-results-message');
                if (visibleRows.length === 0) {
                    if (!noResultsMessage) {
                        const message = document.createElement('p');
                        message.id = 'no-results-message';
                        message.textContent = 'No se encontraron clientes que coincidan con la búsqueda.';
                        table.parentNode.insertBefore(message, table.nextSibling);
                    }
                } else {
                    if (noResultsMessage) {
                        noResultsMessage.remove();
                    }
                }
            });
        }

        // Manejo de checkbox y visibilidad del ícono de basurero
        const checkboxes = document.querySelectorAll('.item-checkbox');

        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const row = checkbox.closest('tr');
                const trashIcon = row.querySelector('.trash-icon');
                if (checkbox.checked) {
                    trashIcon.style.display = 'inline';
                } else {
                    trashIcon.style.display = 'none';
                }
            });
        });
    });
</script>

{% endblock %}
