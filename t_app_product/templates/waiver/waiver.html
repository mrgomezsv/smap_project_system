{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Administración de Datos de Waiver</h2>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="waiverTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="registered-users-tab" data-bs-toggle="tab" href="#registered-users" role="tab" aria-controls="registered-users" aria-selected="true">
                Clientes Registrados en el Waiver
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="add-email-tab" data-bs-toggle="tab" href="#add-email" role="tab" aria-controls="add-email" aria-selected="false">
                Agregar Colaborador
            </a>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content mt-3" id="waiverTabsContent">
        <!-- Pestaña de Clientes Registrados en el Waiver -->
        <div class="tab-pane fade show active" id="registered-users" role="tabpanel" aria-labelledby="registered-users-tab">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <div>
                    <h3>Clientes Registrados en el Waiver</h3>
                    <p>En esta pestaña, están los clientes que ya se han registrado en el waiver en la app, y generado ya su QR.</p>
                </div>
                <!-- Formulario de Búsqueda Mejorado -->
                <form class="d-flex ms-3 my-2" role="search" method="get">
                    <div class="input-group">
                        <!-- Ícono de Búsqueda -->
                        <span class="input-group-text" id="search-icon">
                            <i class="bi bi-search"></i>
                        </span>
                        <!-- Campo de Entrada de Búsqueda -->
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar..." aria-label="Buscar" aria-describedby="search-icon">
                    </div>
                </form>
            </div>

            <table class="table table-striped" id="clientesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Código QR Asociado</th>
                        <th>Nombre del Titular</th>
                        <th>Nombre del Familiar</th>
                        <th>Edad del Familiar</th>
                        <th>Fecha de Registro</th>
                        <th>Correo Electrónico</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in waiver_clientes %}
                        <tr>
                            <td>{{ cliente.id }}</td>
                            <td>{{ cliente.user_id }}</td>
                            <td>{{ cliente.user_name }}</td>
                            <td>{{ cliente.relative_name }}</td>
                            <td>{{ cliente.relative_age }}</td>
                            <td>{{ cliente.timestamp }}</td>
                            <td>{{ cliente.user_email }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Mensaje si no se encuentran resultados -->
            {% if waiver_clientes.count == 0 %}
                <p>No se encontraron clientes que coincidan con la búsqueda.</p>
            {% endif %}
        </div>

        <!-- Pestaña de Agregar Correo Electrónico -->
        <div class="tab-pane fade" id="add-email" role="tabpanel" aria-labelledby="add-email-tab">
            <h3>Agregar Colaborador</h3>
            <p>En este apartado agregaremos los correos electrónicos de los colaboradores que validarán (escanearán) el QR de cada cliente en la APP.</p>
            <form method="post" novalidate>
                {% csrf_token %}
                {{ form.as_p }}  <!-- Renderizamos el formulario -->
                <button type="submit" class="btn btn-primary">Agregar</button>
            </form>

            <hr>

            <!-- Tabla de correos electrónicos -->
            <h3>Lista de Correos Electrónicos Autorizados para Validar QR en la APP</h3>
            <p>Este es el listado de personas que tendrán acceso a Custom Waiver Validator en la APP. Por el momento no se puede borrar o editar esta lista, pero se podrá próximamente; por el momento solo se puede agregar.</p>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Fecha de Creación</th>
                        <th>Acciones</th> <!-- Nueva columna para el ícono -->
                    </tr>
                </thead>
                <tbody>
                    {% for validator in waiver_validators %}
                        <tr>
                            <td>{{ validator.email }}</td>
                            <td>{{ validator.created_at }}</td>
                            <td>
                                <!-- Ícono de basurero -->
                                <i class="bi bi-trash"></i>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- Incluir Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Script de Búsqueda -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('clientesTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');

        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent.toLowerCase();
                    if (cellText.indexOf(filter) > -1) {
                        match = true;
                        break;
                    }
                }

                if (match) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }

            // Mostrar mensaje si no hay coincidencias
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            const noResultsMessage = document.getElementById('no-results-message');
            if (visibleRows.length === 0) {
                if (!noResultsMessage) {
                    const message = document.createElement('p');
                    message.id = 'no-results-message';
                    message.textContent = 'No se encontraron clientes que coincidan con la búsqueda.';
                    table.parentNode.insertBefore(message, table.nextSibling);
                }
            } else {
                if (noResultsMessage) {
                    noResultsMessage.remove();
                }
            }
        });
    });
</script>

{% endblock %}
